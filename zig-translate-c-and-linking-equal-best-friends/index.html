<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Zig translate-c and linking equal best friends</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link
      href="data:image/gif;base64,R0lGODlhEAAQAPMKAAAAAAAAAFBxYfKRAOLSIJGhgfKRkfCxkPKykf7+/v///wAAAAAAAAAAAAAAAAAAACH5BAEAAAAALAAAAAAQABAAAARdEMhAa5UYBMJ7D9nGDQRJcqC2mWVLUtpHIdU3UUoe5MqlEjtFITgEggKIZIU2U04M0KQUakg9DdIk1IoJYJfVTChLE3cFgl0AzZ0g2BR0OqSgpXtpQdltVwj8SFYRADs="
      rel="icon"
    />
    <link href="https://blog.jfo.click/style.css" type="text/css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta property="og:title" content="Zig translate-c and linking equal best friends" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://blog.jfo.click/zig-translate-c-and-linking-equal-best-friends" />
    <meta property="og:image" content="https://blog.jfo.click/desk.jpg" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:creator" content="@jeffowler" />
  </head>

  <body>
    <div id="content">
      <header class="site-header">
        <h5>jfo</h5> &mdash;
        <a href="https://blog.jfo.click">archive</a> &mdash;
        <a href="https://blog.jfo.click/feed.xml">feed</a> &mdash;
        <a href="mailto:jfo@jfo.click">contact</a>
      </header>

      <article>
        <p></p>
        <h1 class="post-title">Zig translate-c and linking equal best friends</h1>
        <sub>Jul 14, 2022</sub>
        <p></p>
        <div><p>We have a weekly one hour interest group for Zig programming going at Recurse
this batch. It&#39;s called the <em>Zig Zone</em>, which is both descriptive and
alliterative. This is a pattern, other examples on my calendar include:</p>

<ul>
<li>Rust Rodeo</li>
<li>OCaml Oasis</li>
<li>Clojure Conclave</li>
<li>Shader Shindig</li>
<li>Haskell Hangout</li>
<li>Django Discovery</li>
</ul>
<p>Anyway you get the idea.</p>
<p>We all just show up without an agenda and usually someone has something they&#39;ve
been working on they either want to share or pair on. It&#39;s a good time so far!</p>
<p>Last week Veera brought a C project that he was trying to translate into Zig,
but was having trouble sorting out the linking step. This exposed a gotcha that
I think would be easy to get gotted by if you&#39;re new to the tooling, so I
thought I&#39;d write about it here.</p>
<h2 id="the-problem-c-zig-build-process-impedence-mismatch">The Problem: C &lt;-&gt; Zig build process impedence mismatch</h2>
<p>Consider a very simple C program consisting of:</p>

<ul>
<li>main.c - the executable&#39;s entry point</li>
<li>lib.c - a utility function used by main.c</li>
<li>lib.h - the declaration of the utility function used by main.c whose definition lives in lib.c</li>
</ul>
<p>Concretely, that may look like this:</p>

<pre><code class="lang-c"><span class="hljs-comment">// main.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lib.h&quot;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>

<pre><code class="lang-c"><span class="hljs-comment">// lib.c</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">give_me_int_pls</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
};
</code></pre>

<pre><code class="lang-c"><span class="hljs-comment">// lib.h</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">give_me_int_pls</span><span class="hljs-params">()</span>;
</code></pre>
<p>So, the build process will have to do these things in this order:</p>

<ol>
<li>Build an object file &quot;<code>lib.o</code>&quot; from <code>lib.c</code></li>
<li>Build an executable from <code>main.c</code> which is linked with <code>lib.o</code></li>
</ol>
<p>A makefile for this process might look like this (using <a href="https://zig.news/kristoff/compile-a-c-c-project-with-zig-368j">zig as a c
compiler</a>):</p>

<pre><code class="lang-make"><span class="hljs-section">default: lib</span>
    zig cc main.c lib.o

<span class="hljs-section">lib:</span>
    zig cc -c lib.c -o lib.o
</code></pre>
<blockquote>
<p>Note that I&#39;m being explicit about the named output of the <code>lib</code> step with
<code>-o lib.o</code>, but this would also be the default name (or you could name it
arbitrarily)</p>
</blockquote>
<p>So this file is describing the two steps above in a way make is able to execute.</p>

<pre><code class="lang-make"><span class="hljs-section">default: lib</span>
</code></pre>
<p>Says that in order to run the <code>default</code> target, you must first have run the <code>lib</code> target.</p>
<p>So where does <code>lib.h</code> come in here?</p>
<p>The C preprocessor literally inlines the contents of the included file. That
means that what is actually compiled is this:</p>

<pre><code class="lang-c"><span class="hljs-comment">// main.c</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">give_me_int_pls</span><span class="hljs-params">()</span>;

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>
<p>You actually <em>can</em> just use the preprocessor to inline the actual definition of
the function, too, and it will work fine, until it doesn&#39;t. So:</p>

<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lib.c&quot;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>
<p>Becomes</p>

<pre><code class="lang-c"><span class="hljs-type">int</span> <span class="hljs-title function_">give_me_int_pls</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>
<p>Which as you can probably tell at a glance will compile since all references
are defined. This is fine:</p>

<pre><code>zig cc main.c
</code></pre>
<p>The <em>problem</em> here is reusability. This is the problem header files solve.</p>
<p>This is contrived, but... imagine another file <code>lib2.c</code> that also depends on
<code>lib.c</code>, and is used also by <code>main.c</code></p>

<pre><code class="lang-c"><span class="hljs-comment">// lib2.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lib.c&quot;</span></span>
</code></pre>
<p>And</p>

<pre><code class="lang-c"><span class="hljs-comment">// main.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lib.c&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lib2.c&quot;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>
<p>Now, <code>zig cc main.c</code> yields</p>

<pre><code>In file included from main.c:2:
In file included from ./lib2.c:1:
./lib.c:1:5: error: redefinition of &#39;give_me_int_pls&#39;
int give_me_int_pls() {
    ^
./lib.c:1:5: note: previous definition is here
int give_me_int_pls() {
    ^
1 error generated.
</code></pre>
<p>If you think about how the preprocessor is working, this makes a lot of sense,
it&#39;s simply inlining the same definition twice! It&#39;s as if you copy pasted it
in multiple places and then the compiler complains about redefinition.</p>
<p>If <code>#include &quot;lib.c&quot;</code> is changed to <code>#include lib.h</code> in both <code>main.c</code> and
<code>lib2.c</code>, and we try to compile <code>zig cc main.c</code>, we get a new error:</p>

<pre><code>error(link): undefined reference to symbol &#39;_give_me_int_pls&#39;
error(link):   first referenced in &#39;~/.cache/zig/o/079b4b7d39fd4b2ae5bb5ebf3607eb03/main.o&#39;
thread 749363 panic: attempt to unwrap error: UndefinedSymbolReference
</code></pre>
<p>Given what we know, this is also quite intuitive since the header <code>.h</code> file
only <em>declares</em> the signature of the included function, not the definition.
This is where the linking step from before comes in. We are only allowed to
compile the function body once, we are allowed to declare it as many times as
it appears as an included header file. Otherwise, the compiler would be
recompiling the same function body over and over again whenever it was
included, which is extremely wasteful.</p>
<p>Header files are not free either of course, so one side note I&#39;d like to
mention is header guards. These are simple macro definitions that allow the
compiler to only ever execute on the header files the first time they are seen.
System headers all have these and it&#39;s good practice to include them on
projects of any significant size, f.ex <code>stdio.h</code> starts with:</p>

<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span>    _STDIO_H_</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span>    _STDIO_H_</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// Lots of header code</span>
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* _STDIO_H_ */</span></span>
</code></pre>
<p>The next time <code>stdio.h</code> is included in the project, it will skip over all the
meat of this file since <code>_STIOD_H_</code> will be defined. This is very rudimentary
but useful!</p>
<h1 id="what-does-all-this-have-to-do-with-zig-translate-c-">What does all this have to do with <code>zig translate-c</code>?</h1>
<p>Going back to the original project structure of <code>main.c</code>, <code>lib.c</code>, <code>lib.h</code>...</p>
<p>As you may have guessed by the title, Zig has functionality to automatically
translate C code to Zig code. This mostly works pretty well, but of course it
is an automated process, so it will never be perfect. In addition, zig is still
very much unstable so it is extremely possible to run into bugs at this point
still, which we did, but that&#39;s another story!</p>
<p>Veera was translating <code>main.c</code> to <code>main.zig</code> like:</p>

<pre><code>zig translate-c main.c &gt; main.zig
</code></pre>
<p><code>main.zig</code> then, has some standard include cruft in it (but not too much) and
the meat of the direct translation looks like:</p>

<pre><code class="lang-zig"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">give_me_int_pls</span></span>(...) <span class="hljs-built_in">c_int</span>;
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() <span class="hljs-built_in">c_int</span> {
    <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>
<p>Maybe this looks familiar! It has basically translated and inlined the
declaration that was present in the <code>lib.h</code> file.</p>
<p>Attempting to compile this directly with zig will yield a familiar error:</p>

<pre><code>error(link): undefined reference to symbol &#39;_give_me_int_pls&#39;
error(link):   first referenced in &#39;translate-c-ex/zig-cache/o/99916c6db8742334208eb2229c3eccad/main.o&#39;
thread 756003 panic: attempt to unwrap error: UndefinedSymbolReference
</code></pre>
<p>You might expect the <code>zig translate-c</code> to <code>zig build-exe</code> steps to be more
magical, but they require the same linking step as the bare C version.</p>
<p>So we need to have built the <code>lib.o</code> file and passed it into the linker:</p>

<pre><code>zig build-exe main.zig lib.o
</code></pre>
<p>Which will work!</p>
<h2 id="one-more-thing-">One more thing:</h2>
<p>If you have run <code>zig translate-c</code> on both <code>main.c</code> <em>and</em> <code>lib.c</code>, you will end
up with basically this:</p>

<pre><code class="lang-zig"><span class="hljs-comment">// main.zig</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">give_me_int_pls</span></span>(...) <span class="hljs-built_in">c_int</span>;
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() <span class="hljs-built_in">c_int</span> {
    <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>

<pre><code class="lang-zig"><span class="hljs-comment">// lib.zig</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">give_me_int_pls</span></span>() <span class="hljs-built_in">c_int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
}
</code></pre>
<p>Now if you&#39;re not looking closely, it is reasonable to assume that <code>zig
build-exe main.zig</code> will &quot;just work&quot; in this case, since they are both zig
files, right? But again, it&#39;s translating the C code directly, and the C code
is simply including the header files to be linked up later. If you try <code>zig
build-exe main.zig</code> you will hit the same familiar undefined symbol error.</p>
<p>What I would recommend instead, if you&#39;re working with files you control and
want them to all be zig, is to use the output of <code>zig translate-c</code> as a
starting point, and hand tune them to be more idiomatic.</p>
<p>To whit:</p>

<pre><code class="lang-zig"><span class="hljs-comment">// main.zig</span>
<span class="hljs-keyword">const</span> give_me_int_pls = <span class="hljs-meta">@import</span>(<span class="hljs-string">&quot;./lib.zig&quot;</span>).give_me_int_pls;

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() <span class="hljs-built_in">c_int</span> {
    <span class="hljs-keyword">return</span> give_me_int_pls();
}
</code></pre>

<pre><code class="lang-zig"><span class="hljs-comment">// lib.zig</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">give_me_int_pls</span></span>() <span class="hljs-built_in">c_int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
}
</code></pre>
<p>This works because it&#39;s all just zig code now! The zig compiler on its own is
smart enough to do the guarding and linking steps with using the <code>@import</code>
builtin, but with only the forward declarations, the linking step is necessary
since the compiler and linker really won&#39;t have any idea of where to look for
the definitions unless you specify them in the linking step.</p>
<p>Also, though I&#39;m using the <code>translate-c</code> command in the makefile target, I
really don&#39;t think it&#39;s intended to be integrated into a build process like
that, and is more designed for one time use and fine-tuning as I suggest above.
This is in fact the plan for maintaining the C++ <a href="https://github.com/ziglang/zig/issues/853#issue-307371155">stage 1
compiler</a> in
perpetuity post bootstrapping!</p>
<p>You can see some of these examples <a href="https://github.com/jfo/translate-c-ex">here</a>.</p>
<h2 id="addenda">Addenda</h2>

<ol>
<li><p>I forgot all about this but I basically wrote this whole post before realizing
I had <a href="https://blog.jfo.click/sild-header-files/">kind of already written it
before</a>. Double content.</p>
</li>
<li><p>The next step here would be to use the zig build system directly instead of
make. I haven&#39;t learned to work with that yet, and this post is just a linking
example.</p>
</li>
</ol>
</div>
      </article>
    </div>

    <script async defer src="https://analytics.jfo.click/latest.js"></script>
    <noscript
      ><img src="https://analytics.jfo.click/noscript.gif" alt=""
    /></noscript>
  </body>
</html>
